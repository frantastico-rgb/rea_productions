<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGP REA Productions - Gesti√≥n de Proyectos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .project-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
        }
        
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .project-card h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .project-card .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .status.desarrollo { background: #ffc107; color: #000; }
        .status.preproduccion { background: #17a2b8; color: white; }
        .status.rodaje { background: #28a745; color: white; }
        .status.postproduccion { background: #6f42c1; color: white; }
        .status.completado { background: #28a745; color: white; }
        .status.cancelado { background: #dc3545; color: white; }
        
        .project-info {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .project-budget {
            color: #28a745;
            font-weight: 600;
            font-size: 18px;
            margin: 10px 0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .project-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üé¨ SGP REA Productions</h1>
            <p>Sistema de Gesti√≥n de Producci√≥n - Gesti√≥n de Proyectos</p>
        </div>

        <!-- Formulario de Creaci√≥n -->
        <div class="card">
            <h2>‚ûï Crear Nuevo Proyecto</h2>
            <div id="alertContainer"></div>
            
            <form id="projectForm">
                <div class="form-group">
                    <label for="title">T√≠tulo del Proyecto *</label>
                    <input type="text" id="title" name="title" required placeholder="Ej: El √öltimo Suspiro">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="slug">Slug (URL amigable) *</label>
                        <input type="text" id="slug" name="slug" required placeholder="ej: el-ultimo-suspiro">
                    </div>

                    <div class="form-group">
                        <label for="status">Estado *</label>
                        <select id="status" name="status" required>
                            <option value="desarrollo">Desarrollo</option>
                            <option value="preproduccion">Pre-producci√≥n</option>
                            <option value="rodaje">Rodaje</option>
                            <option value="postproduccion">Post-producci√≥n</option>
                            <option value="distribucion">Distribuci√≥n</option>
                            <option value="completado">Completado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Descripci√≥n</label>
                    <textarea id="description" name="description" placeholder="Descripci√≥n breve del proyecto"></textarea>
                </div>

                <div class="form-group">
                    <label for="synopsis">Sinopsis</label>
                    <textarea id="synopsis" name="synopsis" placeholder="Sinopsis detallada del proyecto"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="genre">G√©nero</label>
                        <input type="text" id="genre" name="genre" placeholder="Ej: Drama, Acci√≥n, Comedia">
                    </div>

                    <div class="form-group">
                        <label for="target_duration">Duraci√≥n (minutos)</label>
                        <input type="number" id="target_duration" name="target_duration" placeholder="90">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="budget_total">Presupuesto Total (COP)</label>
                        <input type="number" id="budget_total" name="budget_total" step="0.01" placeholder="500000">
                    </div>

                    <div class="form-group">
                        <label for="target_audience">P√∫blico Objetivo</label>
                        <input type="text" id="target_audience" name="target_audience" placeholder="Ej: Todo p√∫blico">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="start_date">Fecha de Inicio</label>
                        <input type="date" id="start_date" name="start_date">
                    </div>

                    <div class="form-group">
                        <label for="end_date">Fecha de Fin</label>
                        <input type="date" id="end_date" name="end_date">
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">üé¨ Crear Proyecto</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('projectForm').reset()">üîÑ Limpiar</button>
                </div>
            </form>
        </div>

        <!-- Lista de Proyectos -->
        <div class="card">
            <h2>üìã Proyectos Existentes</h2>
            <div id="projectsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Cargando proyectos...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';

        // Auto-generar slug desde el t√≠tulo
        document.getElementById('title').addEventListener('input', function(e) {
            const slug = e.target.value
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
            document.getElementById('slug').value = slug;
        });

        // Cargar proyectos al inicio
        loadProjects();

        // Manejar env√≠o del formulario
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const projectData = {
                title: formData.get('title'),
                slug: formData.get('slug'),
                description: formData.get('description') || null,
                synopsis: formData.get('synopsis') || null,
                status: formData.get('status'),
                genre: formData.get('genre') || null,
                target_duration: formData.get('target_duration') ? parseInt(formData.get('target_duration')) : null,
                budget_total: formData.get('budget_total') ? parseFloat(formData.get('budget_total')) : null,
                target_audience: formData.get('target_audience') || null,
                start_date: formData.get('start_date') || null,
                end_date: formData.get('end_date') || null,
                created_by: 1 // Usuario por defecto
            };

            console.log('üì¶ Datos del proyecto a crear:', projectData);

            try {
                showAlert('Creando proyecto...', 'info');
                
                console.log(`üåê Enviando POST a: ${API_URL}/projects`);
                
                const response = await fetch(`${API_URL}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });

                console.log('üì° Respuesta del servidor:', response.status, response.statusText);

                const result = await response.json();
                console.log('üìÑ Resultado:', result);

                if (response.ok) {
                    showAlert(`‚úÖ Proyecto "${result.data.title}" creado exitosamente!`, 'success');
                    e.target.reset();
                    loadProjects();
                } else {
                    console.error('‚ùå Error del servidor:', result);
                    showAlert(`‚ùå Error: ${result.error || result.message}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showAlert(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        });

        // Funci√≥n para cargar proyectos
        async function loadProjects() {
            const container = document.getElementById('projectsContainer');
            
            try {
                const response = await fetch(`${API_URL}/projects?limit=20`);
                const result = await response.json();

                if (response.ok && result.data.length > 0) {
                    container.innerHTML = `
                        <div class="projects-grid">
                            ${result.data.map(project => createProjectCard(project)).join('')}
                        </div>
                    `;
                    
                    // Agregar event listeners a los botones
                    attachProjectCardListeners();
                } else {
                    container.innerHTML = '<p class="loading">No hay proyectos registrados. Crea el primero!</p>';
                }
            } catch (error) {
                container.innerHTML = `<p class="alert alert-error">Error cargando proyectos: ${error.message}</p>`;
            }
        }
        
        // Agregar event listeners a las tarjetas de proyectos
        function attachProjectCardListeners() {
            // Botones "Ver"
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', function() {
                    const card = this.closest('.project-card');
                    const projectId = card.dataset.projectId;
                    viewProject(projectId);
                });
            });
            
            // Botones "Eliminar"
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const card = this.closest('.project-card');
                    const projectId = card.dataset.projectId;
                    const projectTitle = card.dataset.projectTitle;
                    deleteProject(projectId, projectTitle);
                });
            });
        }

        // Crear tarjeta de proyecto
        function createProjectCard(project) {
            const budget = project.budget_total 
                ? `$${parseFloat(project.budget_total).toLocaleString('es-CO')}` 
                : 'Sin presupuesto';
            
            return `
                <div class="project-card" data-project-id="${project.id}" data-project-title="${project.title.replace(/"/g, '&quot;')}">
                    <h3>${project.title}</h3>
                    <span class="status ${project.status}">${project.status.toUpperCase()}</span>
                    <div class="project-budget">${budget}</div>
                    <div class="project-info">üìÅ Slug: ${project.slug}</div>
                    ${project.genre ? `<div class="project-info">üé≠ G√©nero: ${project.genre}</div>` : ''}
                    ${project.target_duration ? `<div class="project-info">‚è±Ô∏è Duraci√≥n: ${project.target_duration} min</div>` : ''}
                    ${project.start_date ? `<div class="project-info">üìÖ Inicio: ${new Date(project.start_date).toLocaleDateString('es-CO')}</div>` : ''}
                    <div class="project-actions">
                        <button class="btn btn-primary btn-small btn-view">üëÅÔ∏è Ver</button>
                        <button class="btn btn-secondary btn-small btn-delete">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `;
        }

        // Ver detalle del proyecto
        async function viewProject(id) {
            try {
                const response = await fetch(`${API_URL}/projects/${id}`);
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Proyecto: ${result.data.title}\n\nEstado: ${result.data.status}\nPresupuesto: $${result.data.budget_total?.toLocaleString('es-CO') || 0}\n\nEscenas: ${result.data.stats.scenes_count}\nPersonajes: ${result.data.stats.characters_count}\nArchivos: ${result.data.stats.files_count}`);
                }
            } catch (error) {
                alert('Error cargando detalles: ' + error.message);
            }
        }

        // Eliminar proyecto
        async function deleteProject(id, title) {
            if (!confirm(`¬øEst√°s seguro de eliminar el proyecto "${title}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/projects/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(`‚úÖ Proyecto eliminado exitosamente`, 'success');
                    loadProjects();
                } else {
                    showAlert(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Mostrar alertas
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Recargar proyectos cada 30 segundos
        setInterval(loadProjects, 30000);
    </script>
</body>
</html>
